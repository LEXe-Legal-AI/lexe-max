# QA Protocol v3.2 - Report Esaustivo KB Massimari

**Data:** 2026-01-30
**Versione:** v3.2 (Post Alignment Fix)

---

## EXECUTIVE SUMMARY

### Alignment Fix Results (v3.2)

| Metrica             | Prima | Dopo      | Target | Status |
| ------------------- | ----- | --------- | ------ | ------ |
| **Coverage**        | 0.2%  | **66.7%** | >=60%  | PASS   |
| **Alignment Trust** | N/A   | **100%**  | >=90%  | PASS   |
| **Embedding %**     | N/A   | **0%**    | <10%   | PASS   |

### Match Stage Distribution

```
exact_hash      5,960 (33.3%)  <- contenuto identico
token_jaccard   3,059 (17.1%)
char_ngram      2,743 (15.3%)
unmatched       6,151 (34.3%)
```

### Root Cause Risolto

**Problema:** Unstructured hi_res produceva testo "spaced letters":

- Reference: `"c o r t e  s u p r e m a"`
- Pipeline:  `"CORTE SUPREMA"`
- Jaccard similarity: 0%

**Soluzione:** Estrazione reference units con PyMuPDF (stesso engine della pipeline)

+ normalizzazione v2 con despacing condizionale + SimHash64 per candidate generation.

### Civile vs Penale Gap

| Tipo   | Docs | Massime | Coverage  |
| ------ | ---- | ------- | --------- |
| Penale | 21   | 4,763   | **90.6%** |
| Civile | 37   | 5,330   | **62.6%** |

**Insight:** I volumi Civile hanno meno massime estratte dalla pipeline.
Azione: investigare extraction logic per documenti Civile.

---

================================================================================
QA PROTOCOL - REPORT ESAUSTIVO KB MASSIMARI
Data: 2026-01-30 04:16
================================================================================

================================================================================

1. INVENTARIO DATI
   ================================================================================
   
   PDF nel manifest:                  63
   Reference units (Phase 0):      19448
   Massime pipeline:               10093
   Documenti elaborati:               58
   Doc Intel Run A:                   63
   Doc Intel Run B:                   57
   Sample windows (5x15):            315
   Alignment summaries:               58

================================================================================
2. DOCUMENT INTELLIGENCE (LLM Classification)
================================================================================

   Documenti classificati: 63/63

doc_type distribution:
------------------------------------------------------------

   mixed                         39 ( 61.9%) ########################
   massima_plus_commentary       18 ( 28.6%) ###########
   list_only                      3 (  4.8%) #
   toc_heavy                      3 (  4.8%) #

profile distribution:
------------------------------------------------------------

   structured_parent_child       40 ( 63.5%) #########################
   mixed_hybrid                  11 ( 17.5%) ######
   baseline_toc_filter           10 ( 15.9%) ######
   structured_by_title            2 (  3.2%) #

A/B Test Comparison (temp 0.0 vs 0.1):
------------------------------------------------------------

   Documenti confrontati:      57
   doc_type flip rate:         6 (10.5%)
   profile flip rate:          13 (22.8%)

   doc_type flips:
     Rassegna Civile 2012 - I volume.pdf      massima_plus_commentary -> mixed
     Rassegna della giurisprudenza di legitti massima_plus_commentary -> mixed
     Volume I_2016_Massimario_Civile_1_372.pd mixed -> massima_plus_commentary
     Volume I_2020_Massimario_Civile.pdf      toc_heavy -> mixed
     Volume I_2020_Massimario_Penale.pdf      massima_plus_commentary -> mixed
     Volume IV_2021_Massimario_Civile_Approfo list_only -> massima_plus_commentary

   profile flips:
     2014 Mass civile Vol 2 pagg 280.pdf      baseline_toc_filter -> structured_parent_child
     Rassegna Civile 2012 - I volume.pdf      structured_parent_child -> mixed_hybrid
     rassegna civile 2020 vol_IV.pdf          mixed_hybrid -> structured_parent_child
     Rassegna Penale 2012.pdf                 structured_parent_child -> structured_by_title
     Volume I_2017_Massimario_Penale.pdf      baseline_toc_filter -> mixed_hybrid

================================================================================
3. INGESTION STATISTICS
================================================================================

Massime per anno:
------------------------------------------------------------

   2010:   238 #######
   2011:   292 #########
   2012:   638 #####################
   2013:   859 ############################
   2014:   333 ###########
   2015:   171 #####
   2016:   565 ##################
   2017:   535 #################
   2018:  1372 #############################################
   2019:  1313 ###########################################
   2020:  1135 #####################################
   2021:   905 ##############################
   2022:   569 ##################
   2023:   671 ######################
   2024:   497 ################

Massime per tipo documento:
------------------------------------------------------------

   civile                 5330
   penale                 4763

Top 10 documenti per numero massime:
------------------------------------------------------------

    1. 2018_MASSIMARIO CIVILE VOL. 1 - RASSEGNA DELL (2018)   611
    2. Volume I_2017_Massimario_Penale.pdf           (2017)   392
    3. Rassegna Penale 2013.pdf                      (2013)   391
    4. 2023_MASSIMARIO PENALE VOL. 1 - RASSEGNA DELL (2023)   355
    5. Volume I_2018_Massimario_Penale con Copertina (2018)   319
    6. Volume I_2016_Massimario_Penale.pdf           (2016)   304
    7. Volume unico_2024_Massimario_Penale(volume un (2024)   291
    8. Rassegna Civile 2013 -I volume.pdf            (2013)   263
    9. Volume II_2020_Massimario_Penale.pdf          (2020)   261

10. Volume I_2019_Massimario_Penale.pdf           (2019)   260
    
    Bottom 10 documenti (meno massime):
    
    ------------------------------------------------------------
    
    1. Volume II_2024_Massimario_Civile(volume compl (2024)    28
    2. Volume II_2023_Massimario_Civile(volume compl (2023)    35
    3. Volume I_2017_Massimario_Civile_1_372.pdf     (2017)    41
    4. Volume I_2016_Massimario_Civile_1_372.pdf     (2016)    43
    5. 2014 Mass civile Vol 1 pagg 408.pdf           (2014)    47
    6. Volume I_2023_Massimario_Civile(volume comple (2023)    68
    7. Volume I_2024_Massimario_Civile(volume comple (2024)    68
    8. Volume II_2018_Massimario_Civile_359_724 con  (2018)    70
    9. Volume II_2022_Massimario_Civile(volume compl (2022)    72

11. 2015 approfondimenti tematici Volume 3 Civile (2015)    74

================================================================================
4. REFERENCE ALIGNMENT ANALYSIS
================================================================================

   Documenti analizzati:         58
   Reference units totali:       17913
   Matched:                      11762 (65.66%)
   Unmatched:                    6151 (34.34%)
   Coverage media:               66.73%
   Fragmentation media:          1.00

Coverage distribution:
------------------------------------------------------------

           0%:   0 docs (  0.0%) 
         1-5%:   0 docs (  0.0%) 
        6-25%:   6 docs ( 10.3%) ######
       26-50%:   9 docs ( 15.5%) #########
      51-100%:  43 docs ( 74.1%) ###########################################

Documenti con coverage > 0%:
------------------------------------------------------------

    19: coverage=99.2%
    20: coverage=98.7%
    61: coverage=98.0%
    43: coverage=96.9%
    22: coverage=96.0%
    45: coverage=95.9%
     7: coverage=95.8%
    46: coverage=95.4%
    41: coverage=95.2%
    62: coverage=93.7%

================================================================================
5. REFERENCE UNITS QUALITY ANALYSIS
================================================================================

   Totale units:                 19448
   Chars medio:                  5567
   Chars mediano:                3996
   Chars min/max:                80 / 513342
   Con citazioni:                15535 (79.9%)

Sample reference unit text:
------------------------------------------------------------

   "215 capitolo xvi - il diritto sostanziale del lavoro di diverso avviso..."

================================================================================
6. PIPELINE MASSIME QUALITY
================================================================================

   Totale massime:               10093
   Chars medio:                  6121
   Chars min/max:                150 / 50000
   Con citazioni:                7855

Sample massima text:
------------------------------------------------------------

   ", Mastropietro, Rv. 281593- 01, in cui si ï¿½ affermato, con riguardo al..."

================================================================================
7. PROBLEMI IDENTIFICATI
================================================================================

[MEDIO] Problema #1: Ingestion
------------------------------------------------------------

   Problema:  5 documenti non elaborati
   Causa:     Errori durante guided ingestion (constraint violations)
   Impatto:   Coverage incompleta del corpus

[BASSO] Problema #2: Document Intelligence
------------------------------------------------------------

   Problema:  13 profile flip tra Run A e B
   Causa:     Variabilita LLM anche con temperature bassa
   Impatto:   Leggera incertezza su profili borderline

================================================================================
8. AREE DI MIGLIORAMENTO
================================================================================

#1 [Estrazione Unificata]
------------------------------------------------------------

   Azione:    Usare stesso metodo (PyMuPDF o Unstructured) per reference units e pipeline
   Beneficio: Coverage alignment realistica, validazione ground truth

#2 [Text Normalization]
------------------------------------------------------------

   Azione:    Migliorare normalizzazione per gestire spaziatura anomala
   Beneficio: Matching robusto indipendentemente da estrazione

#3 [TOC Detection]
------------------------------------------------------------

   Azione:    Implementare skip automatico pagine TOC per profili baseline_toc_filter
   Beneficio: Riduzione rumore, massime piu pulite

#4 [Chunking Strategy]
------------------------------------------------------------

   Azione:    Implementare parent-child chunking per profili structured_parent_child
   Beneficio: Context retrieval migliore per massime con commento

#5 [Gate Policy Logging]
------------------------------------------------------------

   Azione:    Aggiungere logging dettagliato decisioni gate
   Beneficio: Debugging e tuning soglie piu facile

================================================================================
9. RACCOMANDAZIONI OPERATIVE
================================================================================

1. DOCUMENT INTELLIGENCE
   
   - Usa temperature=0.0 per massima riproducibilita
   - Profilo default: structured_parent_child (63% dei documenti)
   - Attiva baseline_toc_filter per documenti con >10% pagine TOC

2. EXTRACTION PIPELINE
   
   - PyMuPDF: veloce, testo pulito, ma perde struttura
   - Unstructured: piu lento, preserva struttura, ma spaziatura problematica
   - Raccomandazione: PyMuPDF per produzione, Unstructured per analisi

3. CHUNKING
   
   - mixed (62%): chunking ibrido by_title + by_similarity
   - massima_plus_commentary (29%): parent-child chunking
   - list_only (5%): small chunks, no parent needed
   - toc_heavy (5%): skip TOC pages, aggressive filtering

4. QUALITY GATES
   
   - min_length: 150 chars (default), 120 per legacy
   - citation_ratio: max 3% (default), 5% per citation_dense
   - Skip prime 10-15 pagine per documenti toc_heavy

================================================================================
10. METRICHE FINALI
================================================================================

   +------------------------------------------+--------+
   | Metrica                                  | Valore |
   +------------------------------------------+--------+
   | PDF processati                           |     63 |
   | Documenti classificati                   |     63 |
   | Massime estratte                         |  10093 |
   | Reference units                          |  19448 |
   | Coverage media alignment                 |  66.7% |
   | doc_type stability (A/B)                 |  89.5% |
   | profile stability (A/B)                  |  77.2% |
   +------------------------------------------+--------+

================================================================================
11. ALIGNMENT FIX v3.2 - FILES CREATI
================================================================================

   Scripts e moduli implementati per il fix:

1. scripts/qa/migrations/002_alignment_fix.sql
   
   - Schema updates: qa_runs, reference_version, extraction_engine
   - FK + UNIQUE constraints per qa_run_id
   - Indici per performance (fingerprint, content_hash)

2. src/lexe_api/kb/ingestion/normalization.py
   
   - compute_spaced_letters_score(): Rileva testo spaced
   - normalize_v2(): Normalizzazione con despacing condizionale
   - safe_despace(): Despacing conservativo (>=20 chars)
   - compute_simhash64(): Fingerprint 64-bit per candidate generation
   - hamming_distance(), jaccard_tokens(), ngram_similarity()

3. scripts/qa/backfill_massime_norm.py
   
   - Batch-safe (5000 righe/batch)
   - Idempotente (solo WHERE testo_normalizzato IS NULL)
   - Computa testo_normalizzato, content_hash, text_fingerprint

4. scripts/qa/s0_extract_reference_units_pymupdf.py
   
   - Estrazione reference units con PyMuPDF
   - Segmentazione page-based (indipendente dalla pipeline)
   - Computa norm_v2, content_hash, simhash64

5. scripts/qa/s6_reference_alignment_v2.py
   
   - Candidate generation con progressive hamming (12->16->20)
   - Cascading match: exact_hash -> token_jaccard -> char_ngram
   - Calcola alignment_trust, collision_rate per documento

6. scripts/qa/verify_alignment_fix.py
   
   - Query E1-E6 per verifica guardrails
   - Spaced letters score, coverage, match stages, trust, collision

================================================================================
12. PROSSIMI PASSI
================================================================================

   PRIORITA ALTA:

- [ ] Investigare bassa extraction per volumi Civile

- [ ] Verificare se guided_ingestion_local ha errori per Civile

- [ ] Considerare re-run extraction con parametri diversi
  
  PRIORITA MEDIA:

- [ ] Implementare parent-child chunking per structured_parent_child

- [ ] Aggiungere TOC skip per baseline_toc_filter

- [ ] Benchmark retrieval S1-S5 con nuovi dati
  
  PRIORITA BASSA:

- [ ] Ridurre collision_rate con segmentazione piu fine

- [ ] Aggiungere embedding fallback (attualmente 0%)

================================================================================
[REPORT COMPLETATO]
================================================================================
